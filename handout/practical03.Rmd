---
title: "Méthodes biostatistiques"
subtitle: "Modèles de régression pour données non gaussiennes"
---

Les paramètres suivants doivent être définis dans R ou RStudio afin de reproduire les analyses présentées dans ce document. Les packages **ggplot2**, **hrbrthemes**, **directlabels**, **cowplot**, **texreg** et **rms** ne font pas partie de la distribution R et doivent être téléchargés au préalable (`install.packages(c("ggplot2", "hrbrthemes", "directlabels", "cowplot", "texreg", "rms")`) s'ils ne sont pas déjà installés. Les dépendances de ces packages seront installés automatiquement. On supposera également que les instructions R sont exécutées dans un répertoire de travail avec les fichiers de données accessibles dans un sous-répertoire `data/`. Si ce n'est pas le cas, il suffit de créer un sous-répertoire `data/` et d'y enregistrer les fichiers de données, ou de redéfinir les chemins d'accès dans les instructions de lecture des fichiers de données ci-après.
```{r, message = FALSE}
library(hrbrthemes)
library(directlabels)
library(cowplot)
library(texreg)
library(rms)            ## Hmisc, ggplot2
options(digits = 6, show.signif.stars = FALSE)
theme_set(theme_ipsum(base_size = 11))
```

# Régression logistique

## Chargement des données

Les données ont déjà été examinées sous l'angle de la régression linéaire en considérant la variable `bwt` (poids du bébé) comme variable à expliquer. Dans les analyses qui suivent, on va s'intéresser à la variable `low` qui représente une indicatrice pour le cas `bwt<2500`.
```{r}
data(birthwt, package = "MASS")
str(birthwt)
```

Voici quelques pré-traitements sur les variables :
```{r}
birthwt$lwt <- birthwt$lwt * 0.45
birthwt$race <- factor(birthwt$race, levels = 1:3, labels = c("white", "black", "other"))
birthwt$smoke <- factor(birthwt$smoke, levels = 0:1, labels = c("non-smoker", "smoker"))
birthwt$ftv[birthwt$ftv > 2] <- 2 
```

Voici un résumé de la structure de données en considérant la variable `bwt` et en surlignant les observations pour lesquelles `low=1` :

```{r, echo = FALSE}
p <- ggplot(data = birthwt, aes(x = lwt, y = bwt, color = factor(low))) +
       geom_point() +
       geom_smooth(method = "loess", span = 1.5, se = FALSE, color = grey(.3)) +
       scale_color_manual("", values = c("grey50", "lightcoral")) +
       facet_wrap(~ race, ncol = 3) +
       guides(color = FALSE) +
       labs(x = "Mother weight (kg)", y = "Baby weight (g)")
p
```

## Description des variables

```{r}
s <- summary(low ~ age + lwt + race + smoke + ht + ui + ftv, 
             data = birthwt, method = "reverse")
print(s, exclude1 = FALSE, npct = "both")
```

```{r}
d <- aggregate(low ~ race + cut2(lwt, g = 3) + smoke, data = birthwt, sum)
```

```{r}
d$pct <- d$low / nrow(birthwt)
names(d)[2] <- "age"
p <- ggplot(data = d, aes(x = pct, y = age)) +
       geom_line(aes(group = age), color = grey(.7)) +
       geom_point(aes(color = smoke)) +
       scale_color_manual("", values = c("steelblue", "orange")) +
       facet_wrap(~ race, ncol = 3) +
       labs(x = "Proportion weight < 2.5 kg", y = "Mother age")
p 
```

## Modélisation

Le modèle de régression logistique s'écrit :
```{r}
m <- glm(low ~ lwt + race + smoke + ui, data = birthwt, family = binomial)
summary(m)
```

```{r}
confint(m)
exp(coef(m)["smokesmoker"])
```

Voici les prédictions de ce modèle dans le cas `smoke=smoker` et `ui=1` : 
```{r}
d <- expand.grid(lwt = seq(40, 100), race = factor(levels(birthwt$race)), 
                 smoke = "smoker", ui = 1)
d$yhat <- predict(m, d, type = "response")
p <- ggplot(data = d, aes(x = lwt, y = yhat, color = race)) +
       geom_line(aes(group = race), size = 1) +
       scale_color_ipsum() +
       guides(color = FALSE) +
       labs(x = "Mother weight (kg)", y = "Pr(low = 1)", caption = "Predicted response curves")
direct.label(p + aes(label = race), method = "smart.grid") 
```

## Régression Probit

## Cas des données groupées

À titre d'illustration, voici un exemple d'analyse de données médicales pour lesquelles on dispose de la pression systolique (`bpress`) et de la concentration sanguine en cholestérol (`chol`) chez des patients ayant eu ou non un infarctus du myocarde (`hdis`). Le chargement des données ne pose pas de difficulté car les données sont déjà au format R :
```{r}
load("data/hdis.rda")
str(hdis)
```

Voici un résumé de la structure de données :
```{r}
round(xtabs(hdis/total ~ bpress + chol, data = hdis), 2)
```

Pour simplifier l'analyse, on va remplacer les catégories de pression systolique par leur centre de classe et analyser cette seule variable en mode numérique. La deuxième étape consiste donc à agréger les données sur les différents niveaux de cholestérol :
```{r}
labs <- c(111.5,121.5,131.5,141.5,151.5,161.5,176.5,191.5)
hdis$bpress <- rep(labs, each = 7)
d <- aggregate(cbind(hdis, total) ~ bpress, data = hdis, sum)
```

Voici les proportions de cas :
```{r}
d$prop <- d$hdis/d$total
```

Enfin, voici le modèle de régression logistique où, dans le cas des données groupées, il est nécessaire d'indiquer la variable qui code l'événement positif (celui qui nous intéresse) et l'événement négatif (son complémentaire) :
```{r}
m <- glm(cbind(hdis, total-hdis) ~ bpress, data = d, family = binomial)
d$yhat <- predict(m, type = "response")
d
```

Les proportions observées et les valeurs prédites sont représentées dans la figure ci-dessous, la fonction `f` permettant de passer de l'échelle du log odds aux proportions : 
```{r}
f <- function(x) 1/(1 + exp(-(coef(m)[1] + coef(m)[2]*x)))
p <- ggplot(data = d, aes(x = bpress, y = hdis/total)) +
       geom_point() +
       stat_function(fun = f, col = "lightcoral", size = 1) +
       labs(x = "Blodd pressure (mm Hg)", y = "Proportion CHD", caption = "Observed vs. fitted proportions")
p
```

# Régression de Poisson

## Chargement des données

## Description des variables

## Modélisation

# Extension

# Exercices d'application {.tabset}

